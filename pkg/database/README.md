# database说明文档

## 1.database.go

一个redis中含有16个分数据库，该文件中的代码主要实现的是分数据库的操作，也即分数据库的对客户端发送的命令进行分发处理。

1.定义数据结构DB

（1）结构体的第一个字段index表示分数据库的索引；

（2）data字段为该数据库中存放的所有k-v数据，data的底层是一个可并发读写的map；

（3）ttlMap存储的是key的对应的过期时间

（4）versionMap存储key对应的版本号，版本号用于事务提交的时候判断被监控的key是否被修改。

（5）locker在执行复杂的命令使用该互斥锁，复杂命令指得是msetnx、rpush等

（6）AddAof 对命令（修改和写入的命令）进行Aof操作

2.函数实现的功能

（1）判断客户端发过来的指令是事务指令还是普通指令，是事务指令则交给transaction处理，如果是普通的命令，则执行普通的命令；

（2）实现了Time to live的功能；

（3）实现key的版本号的写入和读取操作；

（4）实现分数据库对数据的操作；

## 2.router.go

这个包中主要实现了注册命令的功能：这个包的好处是将redis的命令放在一个hashTable中，我们需要调用什么函数就直接输入相应的命令，
就可以取到对应的执行函数，这样就极大的简化了我们的程序。我们再整个项目启动的时候，会事先将涉及到的redis命令注册到cmdTale中。
比如，string包的最后，再init的函数中调用RegisterCommand将string包涉及到的命令注册到cmdTale中

（1）首先定义了一个普通的map，用来存放redis命令对应的执行函数，一个redis命令对应一个执行函数；

（2）实现了一个注册命令的函数，用来将redis的命令注册到cmdTable中。

（3）最后一个函数isReadOnlyCommand是用来判断一个命令是否是只读的命令。

## transaction.go

这个包主要是处理slava中的事务命令，比如Multi、Exec、Watch等

## tx_utils

这个包主要实现的是PrePare的功能，返回相关的写键和读键，以及主要实现的是回滚，返回给定命令行的撤消日志，仅在事务中使用
